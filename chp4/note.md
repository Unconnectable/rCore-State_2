# chp1

基本概念和术语

MMU:内存管理单元

对齐:

例如4KB对齐,也就是地址**mod 4096==0**,例如0x1000 (4096)  0x2000(8192)是4KB对齐,但是0x2001(8193)不是

再例如虚拟页面如果是4KB对齐,连续的页面按照4KB递增:0x1000 ->0x2000 -> 0x3000

并且如果是4KB对齐 他的**低 12 位必须为 0**以保证**mod 4096==0**





虚拟地址(39bit)

低12位 [0,11]页内偏移(Page offset)

高27位[12,38]虚拟页号(Vitural Page Number)

**物理地址** (56bit)

低12位 [0,11] 同理

高44位 [12,55] 物理页号(Physical Page number)



**`exclusive_access`** 通常表示 **独占访问**

即某一时刻只有一个执行单元(如线程、CPU 核或任务)能访问某个共享资源(如内存、设备或数据结构)

PageTableEntry(**页表项**)是PageTable的基本单位

**跳板** (Trampoline)

#### 1. **TLB 是什么？**

TLB 是 CPU 中专门用于 **加速虚拟地址到物理地址转换的高速缓存**,可理解为 **页表项的缓存**.
当 CPU 访问虚拟地址时,硬件优先查询 TLB,若命中则直接获取物理地址,否则需逐级查页表(性能开销大).

对`linker.ld`的注释

```ld
OUTPUT_ARCH(riscv)
ENTRY(_start)

BASE_ADDRESS = 0x0;
#用户程序的起始虚拟地址为 0x0(需与操作系统的用户地址空间规划一致).

SECTIONS
{
    . = BASE_ADDRESS;
    .text : {
        *(.text.entry)
        *(.text .text.*)
    }
    . = ALIGN(4K);
    .rodata : {
        *(.rodata .rodata.*)
        *(.srodata .srodata.*)
    }
    . = ALIGN(4K);
    .data : {
        *(.data .data.*)
        *(.sdata .sdata.*)
    }
    .bss : {
        start_bss = .;
        *(.bss .bss.*)
        *(.sbss .sbss.*)
        end_bss = .;
    }
    #调试信息(.debug*)和异常处理帧(.eh_frame),
    /DISCARD/ : {
        *(.eh_frame)
        *(.debug*)
    }
}
```

树形结构

`PTE,ppn,vpn,pagetable,pd,vd,maparea`

```
                        ┌───────────────────────┐
                        │     根页表 (Level 2)     │
                        │   (PPN= satp寄存器值)    │
                        │ 512个PTE,占4KB物理页     │
                        └───────────┬─────────────┘
                                    │
                   ┌────────────────┴────────────────┐
                   ▼                                 ▼
┌───────────────────────┐               ┌───────────────────────┐
│  中间页表 (Level 1)    │               │  中间页表 (Level 1)    │
│ (由根页表PTE0指向)     │               │ (由根页表PTE1指向)     │
└───────────┬────────────┘               └───────────────────────┘
            │                                                  
            ▼                                                  
┌───────────────────────┐                          
│  页目录表 (Level 0)    │                          
│ (由中间页表PTE指向)    │                          
└───────────┬────────────┘                          
            │                                      
            ▼                                      
┌───────────────────────┐                          
│     物理页 (4KB)       │                          
│   (存储实际数据/代码)  │                          
└───────────────────────┘                          
```



```
┌──────────────────────────────┐
│        用户态虚拟地址 (VA)      │
│   ┌────────────────────────┐ │
│   │  VPN (Virtual Page Num)│ │
│   │  + 页内偏移 (Offset)    │ │
│   └──────────┬─────────────┘ │
└──────────────┼───────────────┘
               │
               ▼
┌──────────────────────────────┐
│         MapArea              │  (管理连续虚拟内存区域)
│   ┌────────────────────────┐ │
│   │ - vpn_range: VPNRange  │ ◄───┐
│   │ - map_type: Identical  │ │   │
│   │ - map_perm: R/W/X/U    │ │   │
│   └──────────┬─────────────┘ │   │
└──────────────┼───────────────┘   │
               │                   │
               ▼                   │
┌──────────────────────────────┐  │
│         PageTable            │  │  (多级页表控制器)
│   ┌────────────────────────┐ │  │
│   │ - root_ppn: PhysPageNum│ │  │
│   │ - frames: Vec<Frame>   │ │  │
│   └──────────┬─────────────┘ │  │
└──────────────┼───────────────┘  │
               │                  │
               ▼                  │
┌──────────────────────────────┐ │
│  页表项 (PTE) 链表            │ │ (硬件实际使用的结构)
│  ┌───────┐  ┌───────┐  ┌─────┐│ │
│  │  PTE  │→ │  PTE  │→ │ PTE ││ │
│  │ - PFN │  │ - PFN │  │ ... ││ │
│  │ - V/D │  │ - R/W │  └─────┘│ │
│  └───┬───┘  └───┬───┘         │ │
└──────┼──────────┼─────────────┘ │
       │          │               │
       ▼          ▼               │
┌──────────────────────────────┐ │
│        物理页 (Frame)         │ │
│  ┌────────────────────────┐  │ │
│  │ - ppn: PhysPageNum     │  │ │
│  │ - data: [u8; 4096]     │  │ │
│  └──────────┬─────────────┘  │ │
└─────────────┼────────────────┘ │
               │                  │
               ▼                  │
┌──────────────────────────────┐ │
│        虚拟设备 (VD)          │ │ (可选映射)
│   ┌────────────────────────┐ │ │
│   │ - mmio_registers       │ │ │
│   └────────────────────────┘ │ │
└──────────────────────────────┘ │
               ▲                  │
               └──────────────────┘
```

新的`trap.s`

```assembly
```

